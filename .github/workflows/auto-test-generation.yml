name: Auto Test Generation

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx1024m'

jobs:
  generate-tests:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Create test directory structure
      run: |
        mkdir -p src/test/java/com/starbucks/menuaichat/{controller,service,repository,model}
        mkdir -p src/test/resources

    - name: Generate Unit Tests (Smart Templates)
      run: |
        chmod +x .github/scripts/smart-test-generator.sh
        .github/scripts/smart-test-generator.sh



    - name: Check for generated tests
      id: changes
      run: |
        if [[ -n $(git status --porcelain) ]]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "âœ… New tests were generated"
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸  No new tests to generate"
        fi

    - name: Run unit tests only (mocked)
      if: steps.changes.outputs.changes == 'true'
      run: |
        echo "ğŸ§ª Running generated unit tests (all mocked, no external dependencies)..."
        mvn clean test -Dtest="**/*Test" -DfailIfNoTests=false



    - name: Create Pull Request with GitHub CLI
      if: steps.changes.outputs.changes == 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Configure git
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # Create and switch to new branch
        BRANCH_NAME="auto-generated-tests-$(date +%Y%m%d-%H%M%S)"
        git checkout -b "$BRANCH_NAME"
        
        # Add and commit changes
        git add src/test/
        git commit -m "feat: Add auto-generated unit tests

        âœ… Generated unit tests for all Java classes
        âœ… Tests verified to compile and run successfully
        âœ… Includes proper mocking structure
        âœ… Ready for customization with business logic"
        
        # Push branch
        git push origin "$BRANCH_NAME"
        
        # Create PR using GitHub CLI
        gh pr create \
          --title "ğŸ¤– Auto-generated Service Tests" \
          --body "## ğŸ¤– Auto-generated Service Tests âœ…

        This PR contains automatically generated unit tests for Service classes in the Starbucks Menu AI Chat application.

        **âœ… All generated tests have been verified to compile and run successfully!**

        ### What's included:
        - âœ… Unit tests for all @Service classes
        - âœ… Proper mocking of repository dependencies
        - âœ… Test scaffolding ready for customization

        ### Generated test files:
        \`\`\`
        src/test/java/com/starbucks/menuaichat/service/
        â”œâ”€â”€ MenuServiceTest.java
        â”œâ”€â”€ StarbucksAiChatServiceTest.java
        â”œâ”€â”€ DataLoaderServiceTest.java
        â””â”€â”€ SpringAiVectorServiceTest.java
        \`\`\`

        ### Quality assurance:
        - âœ… Tests compile without errors
        - âœ… Tests run successfully 
        - âœ… Proper mocking structure in place
        - âœ… Test configuration verified

        ### Next steps:
        1. Review the generated tests
        2. Implement the TODO sections with actual business logic
        3. Add more specific test cases as needed
        4. Customize assertions for your use cases

        **Note**: Tests are generated as working scaffolding - ready to be customized with your specific logic!" \
          --base master \
          --head "$BRANCH_NAME"

  run-tests:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Run tests
      run: |
        mvn clean test -Dspring.profiles.active=test

    - name: Generate test report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Maven Tests
        path: 'starbucks-menu/target/surefire-reports/*.xml'
        reporter: java-junit