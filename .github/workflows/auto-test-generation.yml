name: Auto Test Generation

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx1024m'

jobs:
  generate-tests:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Create test directory structure
      run: |
        mkdir -p src/test/java/com/starbucks/menuaichat/{controller,service,repository,model}
        mkdir -p src/test/resources

    - name: Generate Unit Tests
      run: |
        python3 .github/scripts/generate-tests.py







    - name: Compile generated tests
      run: |
        mvn compile test-compile

    - name: Check for changes
      id: changes
      run: |
        if [[ -n $(git status --porcelain) ]]; then
          echo "changes=true" >> $GITHUB_OUTPUT
        else
          echo "changes=false" >> $GITHUB_OUTPUT
        fi

    - name: Create Pull Request
      if: steps.changes.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "feat: Add auto-generated unit tests"
        title: "ðŸ¤– Auto-generated Unit Tests"
        body: |
          ## Auto-generated Unit Tests
          
          This PR contains automatically generated unit tests for the Starbucks Menu AI Chat application.
          
          ### What's included:
          - âœ… Unit tests for all service classes
          - âœ… Unit tests for all controller classes  
          - âœ… Unit tests for all repository classes
          - âœ… Unit tests for model classes
          
          ### Generated test files:
          ```
          src/test/java/com/starbucks/menuaichat/
          â”œâ”€â”€ controller/
          â”œâ”€â”€ service/
          â”œâ”€â”€ repository/
          â””â”€â”€ model/
          ```
          
          ### Next steps:
          1. Review the generated tests
          2. Implement the TODO sections with actual test logic
          3. Add more specific test cases as needed
          4. Add mock configurations where needed
          
          **Note**: Tests are generated as scaffolding - you'll need to implement the actual test logic.
        branch: auto-generated-tests
        delete-branch: true

  run-tests:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Run tests
      run: |
        mvn clean test -Dspring.profiles.active=test

    - name: Generate test report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Maven Tests
        path: 'starbucks-menu/target/surefire-reports/*.xml'
        reporter: java-junit