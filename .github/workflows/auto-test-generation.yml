name: Auto Test Generation

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx1024m'

jobs:
  generate-tests:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Create test directory structure
      run: |
        mkdir -p src/test/java/com/starbucks/menuaichat/{controller,service,repository,model}
        mkdir -p src/test/resources

    - name: Generate Unit Tests
      run: |
        python3 .github/scripts/generate-tests.py

    - name: Create test configuration (if needed)
      run: |
        if [ ! -f "src/test/resources/application-test.yml" ]; then
          cat > src/test/resources/application-test.yml << 'EOF'
        spring:
          datasource:
            url: jdbc:h2:mem:testdb
            driver-class-name: org.h2.Driver
            username: sa
            password: 
          
          sql:
            init:
              mode: never
          
          ai:
            ollama:
              base-url: http://localhost:11434
              chat:
                model: llama3.2
              embedding:
                model: nomic-embed-text

        logging:
          level:
            com.starbucks.menuaichat: INFO
            org.springframework.ai: WARN
            root: WARN
        EOF
        fi

    - name: Check for generated tests
      id: changes
      run: |
        if [[ -n $(git status --porcelain) ]]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "âœ… New tests were generated"
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸  No new tests to generate"
        fi

    - name: Run generated tests
      if: steps.changes.outputs.changes == 'true'
      run: |
        echo "ğŸ§ª Running generated tests to verify they work..."
        mvn clean test -Dspring.profiles.active=test

    - name: Create Pull Request
      if: steps.changes.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "feat: Add auto-generated unit tests"
        title: "ğŸ¤– Auto-generated Unit Tests"
        body: |
          ## ğŸ¤– Auto-generated Unit Tests âœ…
          
          This PR contains automatically generated unit tests for the Starbucks Menu AI Chat application.
          
          **âœ… All generated tests have been verified to compile and run successfully!**
          
          ### What's included:
          - âœ… Unit tests for all service classes
          - âœ… Unit tests for all controller classes  
          - âœ… Unit tests for all repository classes
          - âœ… Unit tests for model classes
          - âœ… Test configuration files
          
          ### Generated test files:
          ```
          src/test/java/com/starbucks/menuaichat/
          â”œâ”€â”€ controller/
          â”œâ”€â”€ service/
          â”œâ”€â”€ repository/
          â””â”€â”€ model/
          ```
          
          ### Quality assurance:
          - âœ… Tests compile without errors
          - âœ… Tests run successfully 
          - âœ… Proper mocking structure in place
          - âœ… Test configuration verified
          
          ### Next steps:
          1. Review the generated tests
          2. Implement the TODO sections with actual business logic
          3. Add more specific test cases as needed
          4. Customize assertions for your use cases
          
          **Note**: Tests are generated as working scaffolding - ready to be customized with your specific logic!
        branch: auto-generated-tests
        delete-branch: true

  run-tests:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Run tests
      run: |
        mvn clean test -Dspring.profiles.active=test

    - name: Generate test report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Maven Tests
        path: 'starbucks-menu/target/surefire-reports/*.xml'
        reporter: java-junit